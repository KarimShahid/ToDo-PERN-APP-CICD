name: '2. Terraform EC2 Deployment & Variable Update (Fine-Grained PAT)'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment name'
        required: true
        type: string
        default: 'dev'
      aws_region:
        description: 'AWS Region'
        required: true
        default: 'us-east-1'
        type: string
      vpc_cidr:
        description: 'CIDR block for VPC'
        required: true
        default: '10.0.0.0/16'
        type: string
      ssh_allowed_cidr:
        description: 'CIDR allowed to SSH (e.g. 1.2.3.4/32)'
        required: true
        default: '0.0.0.0/0'
        type: string
      key_name:
        description: 'EC2 key pair name (must exist in AWS)'
        required: true
        default: 'awsKeyPair'
        type: string
      from_port:
        description: 'Security group from port'
        required: true
        default: '5001'
        type: string
      to_port:
        description: 'Security group to port'
        required: true
        default: '5001'
        type: string
      protocol:
        description: 'Security group protocol (tcp/udp)'
        required: true
        default: 'tcp'
        type: string
      trigger_deploy:
        description: 'Trigger Docker deployment after Terraform?'
        required: true
        type: boolean
        default: true

permissions:
  contents: read
  actions: write

jobs:
  terraform-deploy:
    name: 'Terraform: Deploy EC2 Infrastructure'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.7

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ inputs.aws_region || 'us-east-1' }}

    - name: Terraform Init/Validate/Plan/Apply
      working-directory: ./terraform
      env:
        TF_VAR_environment: ${{ inputs.environment }}
        TF_VAR_aws_region: ${{ inputs.aws_region }}
        TF_VAR_vpc_cidr: ${{ inputs.vpc_cidr }}
        TF_VAR_ssh_allowed_cidr: ${{ inputs.ssh_allowed_cidr }}
        TF_VAR_key_name: ${{ inputs.key_name }}
        TF_VAR_from_port: ${{ inputs.from_port }}
        TF_VAR_to_port: ${{ inputs.to_port }}
        TF_VAR_protocol: ${{ inputs.protocol }}
        TF_VAR_tags: >-
          {
            "ManagedBy": "GitHub-Actions",
            "Environment": "${{ inputs.environment }}",
            "DeployedBy": "${{ github.actor }}"
          }
      run: |
        terraform init -upgrade
        terraform validate
        terraform plan -out=tfplan
        terraform apply tfplan

    - name: Extract EC2 Public IP
      id: get_ec2_ip
      working-directory: ./terraform
      run: |
        EC2_IP=$(terraform output -raw ec2_public_ip || echo "FAILED_TO_GET_IP")
        echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
        echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
        echo "ðŸš€ EC2 Public IP: $EC2_IP"
        echo "$EC2_IP" | tee /tmp/ec2_ip.txt

    - name: âœ… Update SERVER_IP Repository Variable (Fine-Grained PAT)
      env:
        GH_TOKEN: ${{ secrets.GIT_PAT }}
      run: |
        if [ -z "$GH_TOKEN" ]; then
          echo "âŒ GIT_PAT secret missing!"
          exit 1
        fi
        
        EC2_IP="${{ steps.get_ec2_ip.outputs.ec2_ip }}"
        echo "Updating SERVER_IP to: $EC2_IP"
        
        RESPONSE=$(curl -s -w "\n%{http_code}" -L \
          -X PATCH \
          -H "Accept: application/vnd.github+json" \
          -H "Content-Type: application/json" \
          -H "Authorization: token $GH_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "https://api.github.com/repos/${{ github.repository }}/actions/variables/SERVER_IP" \
          -d "{\"name\":\"SERVER_IP\",\"value\":\"$EC2_IP\"}")

        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')

        if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… SERVER_IP updated successfully: $EC2_IP"
        else
          echo "âŒ Failed to update SERVER_IP. HTTP: $HTTP_CODE"
          echo "Response: $BODY"
          exit 1
        fi

    - name: ðŸ”„ Trigger Docker Deployment
      if: inputs.trigger_deploy == 'true' && steps.get_ec2_ip.outputs.ec2_ip != 'FAILED_TO_GET_IP'
      env:
        GH_TOKEN: ${{ secrets.GIT_PAT }}
      uses: peter-evans/repository-dispatch@v4
      with:
        token: ${{ secrets.GIT_PAT }}
        event-type: deploy-app
        client-payload: >-
          {
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "ec2_ip": "${{ steps.get_ec2_ip.outputs.ec2_ip }}",
            "environment": "${{ inputs.environment }}",
            "aws_region": "${{ inputs.aws_region }}",
            "triggered_by": "${{ github.actor }}",
            "run_id": "${{ github.run_id }}",
            "deployment_time": "${{ fromJson('{"timestamp": "'$(date -Iseconds)'"}') }}"
          }